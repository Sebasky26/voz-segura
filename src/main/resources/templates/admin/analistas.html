<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Voz Segura - Gestión de Analistas</title>
    <link rel="stylesheet" th:href="@{/css/main.css?v=6}" href="/css/main.css?v=6"/>
</head>
<body class="vs-app">

<header class="vs-header">
    <div class="vs-container vs-container-wide">
        <div class="vs-brand" aria-label="Voz Segura">
            <img class="vs-brand__logo" th:src="@{/img/logo-voz-segura.svg?v=4}" alt="Logo de Voz Segura">
            <div class="vs-brand__text">
                <div class="vs-brand__title">Voz Segura</div>
                <div class="vs-brand__subtitle">Gestión de Analistas</div>
            </div>
        </div>
        <nav class="vs-nav" aria-label="Navegación">
            <a th:href="@{/admin/panel}" class="vs-nav__link">Panel</a>
            <a th:href="@{/admin/reglas}" class="vs-nav__link">Reglas</a>
            <a th:href="@{/admin/analistas}" class="vs-nav__link vs-nav__link--active">Analistas</a>
            <a th:href="@{/admin/logs}" class="vs-nav__link">Logs</a>
            <a th:href="@{/auth/logout}" class="vs-nav__link">Cerrar sesión</a>
        </nav>
    </div>
</header>

<main class="vs-container vs-container-wide">
    <section class="vs-card" aria-labelledby="titulo-analistas">
        <div class="vs-card__header">
            <h1 id="titulo-analistas" class="vs-card__title">Gestión de Analistas</h1>
            <p class="vs-card__subtitle">Crear y administrar cuentas de personal del sistema</p>
        </div>

        <!-- Mensajes -->
        <div th:if="${error}" class="vs-alert vs-alert--error vs-mb-4" role="alert">
            <strong>Error:</strong> <span th:text="${error}"></span>
        </div>

        <div th:if="${success}" class="vs-alert vs-alert--success vs-mb-4" role="status">
            <span th:text="${success}"></span>
        </div>

        <!-- Formulario crear analista -->
        <div class="vs-section vs-mb-6">
            <h3 class="vs-section__title">Nuevo Analista</h3>

            <form th:action="@{/admin/analistas/crear}" method="post" class="vs-form">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <input type="hidden" name="role" value="ANALYST"/>

                <div class="vs-grid vs-grid--2cols">
                    <div class="vs-form__group">
                        <label class="vs-form__label vs-form__label--required" for="username">Username</label>
                        <input type="text"
                               id="username"
                               name="username"
                               class="vs-input"
                               required
                               maxlength="100"
                               placeholder="ej: marlon.vinueza"/>
                        <small class="vs-form__help">Identificador único del analista</small>
                    </div>

                    <div class="vs-form__group">
                        <label class="vs-form__label vs-form__label--required" for="cedula">Cédula</label>
                        <input type="text"
                               id="cedula"
                               name="cedula"
                               class="vs-input"
                               required
                               maxlength="10"
                               pattern="[0-9]{10}"
                               placeholder="1234567890"/>
                        <small class="vs-form__help">Debe existir en Registro Civil (10 dígitos)</small>
                    </div>

                    <div class="vs-form__group">
                        <label class="vs-form__label" for="email">Email</label>
                        <input type="email"
                               id="email"
                               name="email"
                               class="vs-input"
                               maxlength="100"
                               placeholder="ejemplo@epn.edu.ec"/>
                        <small class="vs-form__help">Para envío de OTP (opcional, se cifrará)</small>
                    </div>

                    <div class="vs-form__group">
                        <label class="vs-form__label" for="phone">Teléfono</label>
                        <input type="tel"
                               id="phone"
                               name="phone"
                               class="vs-input"
                               maxlength="20"
                               placeholder="0998765432"/>
                        <small class="vs-form__help">Opcional, se almacena cifrado</small>
                    </div>
                </div>

                <div class="vs-form__group" style="margin-top: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 0.5rem; border: 1px solid #e9ecef;">
                        <svg style="flex-shrink: 0; width: 20px; height: 20px; color: #0066cc;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div style="flex: 1;">
                            <p style="margin: 0; font-size: 0.875rem; color: #495057;">
                                <strong>Contraseña temporal:</strong> Se generará automáticamente y se mostrará <strong>una sola vez</strong> tras la creación.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="vs-button-group">
                    <button type="submit" class="vs-button vs-button--primary">Crear Analista</button>
                </div>
            </form>
        </div>

        <!-- Lista de analistas -->
        <div class="vs-section">
            <h3 class="vs-section__title">Personal del Sistema</h3>

            <div class="vs-table-wrapper">
                <table class="vs-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Rol</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="staff : ${analistas}" th:if="${analistas != null and !analistas.isEmpty()}">
                            <td th:text="${staff.id}"></td>
                            <td th:text="${staff.username}"></td>
                            <td>
                                <span class="vs-badge"
                                      th:classappend="${staff.role == 'ADMIN'} ? 'vs-badge--danger' : 'vs-badge--info'"
                                      th:text="${staff.role}"></span>
                            </td>
                            <td>
                                <span class="vs-badge"
                                      th:classappend="${staff.enabled} ? 'vs-badge--success' : 'vs-badge--secondary'"
                                      th:text="${staff.enabled ? 'Activo' : 'Inactivo'}"></span>
                            </td>
                            <td>
                                <form th:action="@{/admin/analistas/{id}/toggle(id=${staff.id})}" method="post" style="display:inline;">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <button type="submit"
                                            class="vs-button vs-button--sm"
                                            th:classappend="${staff.enabled} ? 'vs-button--secondary' : 'vs-button--primary'"
                                            th:text="${staff.enabled ? 'Desactivar' : 'Activar'}"></button>
                                </form>
                            </td>
                        </tr>
                        <tr th:if="${analistas == null or analistas.isEmpty()}">
                            <td colspan="6" style="text-align: center; padding: 2rem;">
                                No hay usuarios registrados
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>
</main>

</body>
</html>
