<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Voz Segura — Logs del sistema</title>
    <link rel="stylesheet" th:href="@{/css/main.css?v=5}" href="/css/main.css?v=5"/>
</head>
<body class="vs-app">

<header class="vs-header">
    <div class="vs-container vs-container-wide">
        <div class="vs-brand" aria-label="Voz Segura">
            <img class="vs-brand__logo" th:src="@{/img/logo-voz-segura.svg?v=4}" alt="Logo de Voz Segura">
            <div class="vs-brand__text">
                <div class="vs-brand__title">Voz Segura</div>
                <div class="vs-brand__subtitle">Logs del sistema</div>
            </div>
        </div>
        <nav class="vs-nav" aria-label="Navegación">
            <a th:href="@{/admin/panel}" class="vs-nav__link">Panel</a>
            <a th:href="@{/admin/reglas}" class="vs-nav__link">Reglas</a>
            <a th:href="@{/admin/analistas}" class="vs-nav__link">Analistas</a>
            <a th:href="@{/admin/logs}" class="vs-nav__link">Logs</a>
            <a th:href="@{/auth/logout}" class="vs-nav__link">Cerrar sesión</a>
        </nav>
    </div>
</header>

<main class="vs-container vs-container-wide">
    <!-- Notificaciones -->
    <div th:if="${success}" data-vs-success th:data-vs-success="${success}" style="display:none;"></div>
    <div th:if="${error}" data-vs-error th:data-vs-error="${error}" style="display:none;"></div>
    
    <section class="vs-card" aria-labelledby="titulo-logs">
        <div class="vs-card__header">
            <h1 id="titulo-logs" class="vs-card__title">Logs del sistema</h1>
            <p class="vs-card__subtitle">Registro de actividad (sin datos personales)</p>
        </div>

        <form th:action="@{/admin/logs}" method="get" class="vs-mb-6">
            <div class="vs-grid vs-grid--2cols">
                <div class="vs-form__group">
                    <label class="vs-form__label" for="eventType">Tipo de evento</label>
                    <select id="eventType" name="eventType" class="vs-select">
                        <option th:each="entry : ${eventTypes}"
                                th:value="${entry.key}"
                                th:text="${entry.value}"
                                th:selected="${selectedEventType == entry.key}">
                        </option>
                    </select>
                </div>

                <div class="vs-form__group">
                    <div class="vs-button-group">
                        <button type="submit" class="vs-button vs-button--primary">Filtrar</button>
                        <a th:href="@{/admin/logs}" class="vs-button vs-button--secondary">Limpiar</a>
                    </div>
                </div>
            </div>
        </form>

        <div class="vs-table-wrapper">
            <table class="vs-table">
                <thead>
                <tr>
                    <th>Fecha/Hora</th>
                    <th>Tipo</th>
                    <th>Rol</th>
                    <th>Usuario</th>
                    <th>Referencia</th>
                    <th>Detalle</th>
                </tr>
                </thead>
                <tbody>
                <tr th:if="${events.isEmpty()}">
                    <td colspan="6" class="vs-table-empty">No hay eventos.</td>
                </tr>

                <tr th:each="event : ${events}">
                    <td th:text="${#temporals.format(event.eventTime, 'dd MMM yyyy HH:mm:ss')}">01 ene 2026</td>

                    <td>
                        <span class="vs-badge"
                              th:classappend="${event.eventType.contains('SUCCESS')} ? 'vs-badge--success' :
                                              (${event.eventType.contains('FAILED') or event.eventType.contains('ERROR')} ? 'vs-badge--danger' :
                                              (${event.eventType.contains('CREATED') or event.eventType.contains('SUBMITTED')} ? 'vs-badge--info' : 'vs-badge--warning'))"
                              th:text="${event.eventType}">EVENTO</span>
                    </td>

                    <td th:text="${event.actorRole ?: 'SYSTEM'}">ANALYST</td>

                    <td>
                        <code th:if="${event.actorUsername}"
                              th:text="${event.actorUsername}">USR-XXXXX</code>
                        <span th:unless="${event.actorUsername}">-</span>
                    </td>

                    <td>
                        <code th:if="${event.trackingId}"
                              th:text="${#strings.abbreviate(event.trackingId, 15)}">ABC</code>
                        <span th:unless="${event.trackingId}">-</span>
                    </td>

                    <td th:text="${event.details ?: '-'}">Detalle</td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Paginación mejorada -->
        <div class="vs-mt-6" th:if="${totalPages > 1}">
            <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; flex-wrap: wrap;">

                <!-- Botón Anterior -->
                <a th:if="${currentPage > 0}"
                   th:href="@{/admin/logs(page=${currentPage - 1}, eventType=${selectedEventType})}"
                   class="vs-button vs-button--sm vs-button--secondary"
                   style="min-width: 90px;">← Anterior</a>

                <span th:if="${currentPage == 0}"
                      class="vs-button vs-button--sm vs-button--secondary"
                      style="min-width: 90px; opacity: 0.5; cursor: not-allowed;">← Anterior</span>

                <!-- Números de página -->
                <div style="display: flex; gap: 0.25rem; align-items: center;">
                    <!-- Iterar TODAS las páginas si hay 5 o menos -->
                    <th:block th:if="${totalPages <= 5}">
                        <th:block th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
                            <a th:if="${i != currentPage}"
                               th:href="@{/admin/logs(page=${i}, eventType=${selectedEventType})}"
                               class="vs-button vs-button--sm vs-button--outline"
                               style="min-width: 40px;"
                               th:text="${i + 1}">1</a>

                            <span th:if="${i == currentPage}"
                                  class="vs-button vs-button--sm vs-button--primary"
                                  style="min-width: 40px;"
                                  th:text="${i + 1}">1</span>
                        </th:block>
                    </th:block>

                    <!-- Si hay más de 5 páginas, mostrar con puntos suspensivos -->
                    <th:block th:if="${totalPages > 5}">
                        <!-- Primera página -->
                        <a th:if="${currentPage != 0}"
                           th:href="@{/admin/logs(page=0, eventType=${selectedEventType})}"
                           class="vs-button vs-button--sm vs-button--outline"
                           style="min-width: 40px;">1</a>

                        <span th:if="${currentPage == 0}"
                              class="vs-button vs-button--sm vs-button--primary"
                              style="min-width: 40px;">1</span>

                        <!-- Puntos suspensivos izquierda -->
                        <span th:if="${currentPage > 2}" style="padding: 0 0.5rem; color: #6c757d;">...</span>

                        <!-- Páginas del medio (currentPage ± 1) -->
                        <th:block th:each="i : ${#numbers.sequence(1, totalPages - 2)}">
                            <th:block th:if="${i >= currentPage - 1 and i <= currentPage + 1 and i != 0 and i != totalPages - 1}">
                                <a th:if="${i != currentPage}"
                                   th:href="@{/admin/logs(page=${i}, eventType=${selectedEventType})}"
                                   class="vs-button vs-button--sm vs-button--outline"
                                   style="min-width: 40px;"
                                   th:text="${i + 1}">2</a>

                                <span th:if="${i == currentPage}"
                                      class="vs-button vs-button--sm vs-button--primary"
                                      style="min-width: 40px;"
                                      th:text="${i + 1}">2</span>
                            </th:block>
                        </th:block>

                        <!-- Puntos suspensivos derecha -->
                        <span th:if="${currentPage < totalPages - 3}" style="padding: 0 0.5rem; color: #6c757d;">...</span>

                        <!-- Última página -->
                        <a th:if="${currentPage != totalPages - 1}"
                           th:href="@{/admin/logs(page=${totalPages - 1}, eventType=${selectedEventType})}"
                           class="vs-button vs-button--sm vs-button--outline"
                           style="min-width: 40px;"
                           th:text="${totalPages}">10</a>

                        <span th:if="${currentPage == totalPages - 1}"
                              class="vs-button vs-button--sm vs-button--primary"
                              style="min-width: 40px;"
                              th:text="${totalPages}">10</span>
                    </th:block>
                </div>

                <!-- Botón Siguiente -->
                <a th:if="${currentPage < totalPages - 1}"
                   th:href="@{/admin/logs(page=${currentPage + 1}, eventType=${selectedEventType})}"
                   class="vs-button vs-button--sm vs-button--secondary"
                   style="min-width: 90px;">Siguiente →</a>

                <span th:if="${currentPage == totalPages - 1}"
                      class="vs-button vs-button--sm vs-button--secondary"
                      style="min-width: 90px; opacity: 0.5; cursor: not-allowed;">Siguiente →</span>
            </div>

            <!-- Info de página actual -->
            <div style="text-align: center; margin-top: 1rem; color: #6c757d; font-size: 0.875rem;">
                Página <strong th:text="${currentPage + 1}">1</strong> de <strong th:text="${totalPages}">10</strong>
                (<span th:text="${events.getTotalElements()}">500</span> eventos en total)
            </div>
        </div>
    </section>
</main>

<script th:src="@{/js/notifications.js}" src="/js/notifications.js"></script>
</body>
</html>
