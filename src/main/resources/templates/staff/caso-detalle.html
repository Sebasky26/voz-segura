<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Voz Segura — Detalle de caso</title>
    <link rel="stylesheet" th:href="@{/css/main.css?v=5}" href="/css/main.css?v=5"/>
</head>

<body class="vs-app">

<header class="vs-header">
    <div class="vs-container vs-container-wide">
        <div class="vs-brand" aria-label="Voz Segura">
            <img class="vs-brand__logo" th:src="@{/img/logo-voz-segura.svg?v=4}" alt="Logo de Voz Segura">
            <div class="vs-brand__text">
                <div class="vs-brand__title">Voz Segura</div>
                <div class="vs-brand__subtitle">Detalle de caso</div>
            </div>
        </div>
        <nav class="vs-nav" aria-label="Navegación">
            <a th:href="@{/staff/casos}" class="vs-nav__link">Casos</a>
            <a th:href="@{/auth/logout}" class="vs-nav__link">Cerrar sesión</a>
        </nav>
    </div>
</header>

<main class="vs-container vs-container-wide">
    <section class="vs-card" aria-labelledby="titulo-caso">
        <div class="vs-card__header">
            <h1 id="titulo-caso" class="vs-card__title">Detalle de caso</h1>
            <p class="vs-card__subtitle">
                Código: <code th:text="${complaint.trackingId}">ABC-123</code>
            </p>
        </div>

        <!-- Datos para notificaciones (ocultos, procesados por JS) -->
        <div th:if="${success}" data-vs-success th:data-vs-success="${success}" style="display:none;"></div>
        <div th:if="${error}" data-vs-error th:data-vs-error="${error}" style="display:none;"></div>

        <!-- Resumen (sin summary-card ni badges inventados) -->
        <div class="vs-section vs-mb-6">
            <h3 class="vs-section__title">Resumen</h3>

            <div class="vs-grid vs-grid--3cols">
                <div class="vs-form__group">
                    <label class="vs-form__label">Estado</label>
                    <p th:text="${statusLabel ?: complaint.status}">PENDING</p>
                </div>

                <div class="vs-form__group">
                    <label class="vs-form__label">Prioridad</label>
                    <p th:text="${priorityLabel ?: complaint.priority ?: 'Sin asignar'}">MEDIUM</p>
                </div>

                <div class="vs-form__group">
                    <label class="vs-form__label">Tipo</label>
                    <p th:text="${complaintTypeLabel ?: complaint.complaintType ?: 'Sin clasificar'}">-</p>
                </div>
            </div>
        </div>

        <div th:if="${complaint.derivedTo}" class="vs-alert vs-alert--success vs-mb-6">
            <strong>Derivado a:</strong> <span th:text="${complaint.derivedTo}"></span>
        </div>

        <div class="vs-section vs-mb-6">
            <h3 class="vs-section__title">Empresa denunciada</h3>
            <div class="vs-grid vs-grid--2cols">
                <div class="vs-form__group">
                    <label class="vs-form__label">Nombre</label>
                    <p th:text="${complaint.companyName}">Empresa</p>
                </div>
                <div class="vs-form__group">
                    <label class="vs-form__label">Contacto</label>
                    <p th:text="${complaint.companyContact}">contacto</p>
                </div>
                <div class="vs-form__group vs-grid--full">
                    <label class="vs-form__label">Dirección</label>
                    <p th:text="${complaint.companyAddress}">Dirección</p>
                </div>
            </div>
        </div>

        <div class="vs-section vs-mb-6">
            <h3 class="vs-section__title">Contenido de la denuncia</h3>
            <div class="vs-textarea-readonly" th:text="${decryptedText}">Contenido...</div>
        </div>

        <div class="vs-section vs-mb-6">
            <h3 class="vs-section__title">
                Evidencias (<span th:text="${#lists.size(evidences)}">0</span>)
            </h3>

            <div th:if="${#lists.isEmpty(evidences)}" class="vs-alert vs-alert--info">
                No hay evidencias adjuntas.
            </div>

            <div th:unless="${#lists.isEmpty(evidences)}" class="vs-table-wrapper">
                <table class="vs-table">
                    <thead>
                    <tr><th>Archivo</th><th>Tipo</th><th>Tamaño</th><th>Acciones</th></tr>
                    </thead>
                    <tbody>
                    <tr th:each="ev : ${evidences}">
                        <td th:text="${ev.fileName}">archivo</td>
                        <td th:text="${ev.contentType}">tipo</td>
                        <td th:text="${ev.sizeBytes / 1024 + ' KB'}">100 KB</td>
                        <td>
                            <a th:href="@{/staff/evidencias/{id}(id=${ev.id})}"
                               target="_blank"
                               class="vs-button vs-button--sm vs-button--secondary">
                                Ver
                            </a>
                            <a th:href="@{/staff/evidencias/{id}(id=${ev.id})}"
                               download
                               th:download="${ev.fileName}"
                               class="vs-button vs-button--sm vs-button--outline">
                                Descargar
                            </a>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div th:if="${complaint.analystNotes}" class="vs-section vs-mb-6">
            <h3 class="vs-section__title">Notas del analista</h3>
            <div class="vs-textarea-readonly" th:text="${complaint.analystNotes}"></div>
        </div>

        <!-- Sección de Clasificación (solo si no está finalizado) -->
        <div class="vs-section vs-mb-6" th:unless="${complaint.status == 'DERIVED' or complaint.status == 'REJECTED'}">
            <h3 class="vs-section__title">Clasificación del caso</h3>
            <p class="vs-form__help vs-mb-4">Clasifica el caso correctamente para que pueda ser derivado a la entidad correspondiente.</p>

            <form th:action="@{/staff/casos/{id}/clasificar(id=${complaint.trackingId})}" method="post" id="formClasificar">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <div class="vs-grid vs-grid--2cols">
                    <div class="vs-form__group">
                        <label class="vs-form__label vs-form__label--required" for="complaintType">Tipo de denuncia</label>
                        <select id="complaintType" name="complaintType" class="vs-select" required>
                            <option th:each="t : ${complaintTypes}"
                                    th:value="${t[0]}"
                                    th:text="${t[1]}"
                                    th:selected="${complaint.complaintType == t[0]}"></option>
                        </select>
                    </div>

                    <div class="vs-form__group">
                        <label class="vs-form__label vs-form__label--required" for="priority">Prioridad</label>
                        <select id="priority" name="priority" class="vs-select" required>
                            <option th:each="p : ${priorities}"
                                    th:value="${p[0]}"
                                    th:text="${p[1]}"
                                    th:selected="${complaint.priority == p[0]}"></option>
                        </select>
                    </div>
                </div>

                <div class="vs-form__group vs-mt-4">
                    <label class="vs-form__label" for="analystNotes">Notas internas (opcional)</label>
                    <textarea id="analystNotes" name="analystNotes" class="vs-textarea" rows="2"
                              placeholder="Notas internas visibles solo para analistas..."
                              th:text="${complaint.analystNotes}"></textarea>
                </div>

                <div class="vs-mt-4">
                    <button type="submit" class="vs-button vs-button--secondary">Guardar clasificación</button>
                </div>
            </form>
        </div>

        <!-- Sección de Acciones (solo si no está finalizado) -->
        <div class="vs-section vs-mb-6" th:unless="${complaint.status == 'DERIVED' or complaint.status == 'REJECTED'}">
            <h3 class="vs-section__title">Acciones</h3>

            <div class="vs-grid vs-grid--3cols">
                <!-- Botón Aprobar y Derivar -->
                <div class="vs-action-box vs-action-box--success">
                    <h4 class="vs-h4">Aprobar y derivar</h4>
                    <p class="vs-form__help">El sistema derivará automáticamente según las reglas de derivación configuradas.</p>
                    <form th:action="@{/staff/casos/{id}/aprobar-derivar(id=${complaint.trackingId})}" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button type="submit"
                                class="vs-button vs-button--primary vs-button--block vs-mt-3"
                                th:disabled="${complaint.complaintType == null or complaint.priority == null}"
                                th:title="${complaint.complaintType == null ? 'Debe clasificar primero el caso' : ''}">
                            Aprobar y enviar
                        </button>
                    </form>
                    <p th:if="${complaint.complaintType == null}" class="vs-form__error vs-mt-2">
                        Debe clasificar el caso antes de aprobar.
                    </p>
                </div>

                <!-- Botón Solicitar Información -->
                <div class="vs-action-box vs-action-box--warning">
                    <h4 class="vs-h4">Solicitar información</h4>
                    <form th:action="@{/staff/casos/{id}/solicitar-info(id=${complaint.trackingId})}" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <div class="vs-form__group">
                            <textarea name="motivo" class="vs-textarea" rows="3" required
                                      placeholder="Describa qué información adicional necesita del denunciante..."></textarea>
                        </div>
                        <button type="submit" class="vs-button vs-button--secondary vs-button--block vs-mt-2">
                            ⓘ Solicitar más info
                        </button>
                    </form>
                </div>

                <!-- Botón Rechazar -->
                <div class="vs-action-box vs-action-box--danger">
                    <h4 class="vs-h4">Rechazar denuncia</h4>
                    <form th:action="@{/staff/casos/{id}/rechazar(id=${complaint.trackingId})}" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <div class="vs-form__group">
                            <textarea name="motivo" class="vs-textarea" rows="3" required
                                      placeholder="Indique el motivo del rechazo..."></textarea>
                        </div>
                        <button type="submit" class="vs-button vs-button--ghost vs-button--block vs-mt-2">
                            ✕ Rechazar
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Mensaje si ya está finalizado -->
        <div th:if="${complaint.status == 'DERIVED'}" class="vs-alert vs-alert--success vs-mb-6">
            <strong>Caso derivado:</strong> Este caso ya fue enviado a <span th:text="${complaint.derivedTo}">entidad</span>.
        </div>

        <div th:if="${complaint.status == 'REJECTED'}" class="vs-alert vs-alert--error vs-mb-6">
            <strong>Caso rechazado:</strong> Este caso fue marcado como no procedente.
        </div>

        <div class="vs-button-group vs-mt-6">
            <a th:href="@{/staff/casos}" class="vs-button vs-button--secondary">Volver al listado</a>
        </div>

    </section>
</main>

<script th:src="@{/js/notifications.js}" src="/js/notifications.js"></script>
<script th:src="@{/js/staff-case.js}" src="/js/staff-case.js"></script>
</body>
</html>
