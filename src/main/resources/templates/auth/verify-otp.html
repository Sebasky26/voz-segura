<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Voz Segura — Verificación de seguridad</title>

  <link rel="stylesheet" th:href="@{/css/main.css?v=5}" href="/css/main.css?v=5" />
</head>

<body class="vs-app">

<header class="vs-header">
  <div class="vs-container">

    <div class="vs-brand" aria-label="Voz Segura">
      <img class="vs-brand__logo"
           th:src="@{/img/logo-voz-segura.svg?v=4}"
           alt="Logo de Voz Segura">
      <div class="vs-brand__text">
        <div class="vs-brand__title">Voz Segura</div>
        <div class="vs-brand__subtitle">Verificación de seguridad</div>
      </div>
    </div>

  </div>
</header>

<main class="vs-container">
  <section class="vs-card" aria-labelledby="titulo-otp">

    <div class="vs-card__header">
      <h1 id="titulo-otp" class="vs-card__title">Verificación de seguridad</h1>
      <p class="vs-card__subtitle">Autenticación en dos pasos (código de 6 dígitos)</p>
    </div>

    <div class="vs-alert vs-alert--info vs-mb-4" role="status" aria-live="polite">
      <p class="vs-mb-4">
        Enviamos un código a:
      </p>

      <span class="vs-email-badge" th:text="${maskedEmail}">s***n@epn.edu.ec</span>

      <p class="vs-timer vs-mt-4">
        El código expira en 5 minutos.
      </p>
    </div>

    <div th:if="${success}" class="vs-alert vs-alert--success vs-mb-4" role="status" aria-live="polite">
      <span th:text="${success}">Código reenviado</span>
    </div>

    <div th:if="${param.error}" class="vs-alert vs-alert--error vs-mb-4" role="alert" aria-live="polite">
      No se pudo verificar el código. Revisa e inténtalo otra vez.
    </div>

    <div id="otpUiError" class="vs-alert vs-alert--error vs-mb-4 vs-hidden" role="alert">
      El código debe tener 6 dígitos.
    </div>

    <form th:action="@{/auth/verify-otp}"
          method="post"
          th:object="${otpForm}"
          class="vs-form"
          id="otpForm">

      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

      <div class="vs-form__group">
        <label class="vs-form__label vs-form__label--required" for="otpCode">
          Código de verificación
        </label>

        <input type="text"
               th:field="*{otpCode}"
               id="otpCode"
               class="vs-input vs-otp-input"
               maxlength="6"
               minlength="6"
               inputmode="numeric"
               autocomplete="one-time-code"
               pattern="[0-9]{6}"
               required
               aria-describedby="otpHelp"
               placeholder="000000" />

        <div id="otpHelp" class="vs-form__help">
          Ingresa los 6 dígitos. Solo números.
        </div>
      </div>

      <div class="vs-button-group vs-button-group--space-between vs-mt-6">
        <a th:href="@{/auth/logout}" class="vs-button vs-button--ghost">
          Cancelar
        </a>

        <button type="submit"
                class="vs-button vs-button--primary vs-button--lg"
                id="submitBtn">
          Verificar código
        </button>
      </div>
    </form>

    <div class="vs-mt-4 vs-text-center">
      <p class="vs-timer" id="timerText">
        Puedes reenviar el código en <span id="countdown">60</span> segundos
      </p>

      <form th:action="@{/auth/resend-otp}"
            method="post"
            id="resendForm"
            class="vs-hidden">

        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

        <button type="submit" class="vs-button vs-button--secondary vs-button--sm">
          Reenviar código
        </button>
      </form>
    </div>

  </section>
</main>

<script th:src="@{/js/otp.js}" src="/js/otp.js"></script>

</body>
</html>
