<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Voz Segura ‚Äî Confirmar Identidad</title>
    <link rel="stylesheet" th:href="@{/css/main.css?v=10}" href="/css/main.css?v=10"/>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
</head>

<body class="vs-app">

<!-- Modal T√©rminos y Condiciones -->
<div class="vs-modal-overlay vs-modal--hidden" id="termsModal" role="dialog" aria-modal="true" aria-labelledby="termsTitle">
    <div class="vs-modal" role="document">
        <div class="vs-modal__header">
            <h2 id="termsTitle">T√©rminos y Condiciones</h2>
            <button type="button" class="vs-modal__close" data-terms-close aria-label="Cerrar">&times;</button>
        </div>

        <div class="vs-modal__body">
            <div class="vs-terms">
                <p><strong>Fecha de vigencia: enero 2026</strong></p>

                <h3>Validaci√≥n de identidad</h3>
                <ul>
                    <li>La identidad se valida para evitar suplantaciones.</li>
                    <li>Los datos se usan solo para este proceso de acceso.</li>
                </ul>

                <h3>Protecci√≥n de identidad</h3>
                <ul>
                    <li>La identidad del denunciante no se muestra al personal que revisa los casos.</li>
                    <li>Las denuncias y evidencias se almacenan cifradas y se eliminan tras un per√≠odo de retenci√≥n definido.</li>
                </ul>

                <h3>Revelaci√≥n excepcional</h3>
                <ul>
                    <li>La identidad solo podr√° revelarse en casos excepcionales y bajo autorizaci√≥n formal de la autoridad competente.</li>
                </ul>

                <h3>Uso responsable</h3>
                <ul>
                    <li>No se permite enviar informaci√≥n falsa o malintencionada.</li>
                    <li>No se permite subir contenido ilegal.</li>
                    <li>Las evidencias deben ser l√≠citas y pertinentes al caso.</li>
                </ul>

                <h3>Registros y auditor√≠a</h3>
                <ul>
                    <li>Los registros de auditor√≠a no almacenan datos personales del denunciante.</li>
                    <li>Solo se guardan datos m√≠nimos necesarios para trazabilidad del sistema.</li>
                </ul>
            </div>
        </div>

        <div class="vs-modal__footer">
            <button type="button" class="vs-button vs-button--secondary" data-terms-close>Cerrar</button>
            <button type="button" class="vs-button vs-button--primary" id="acceptTermsBtn">Aceptar t√©rminos</button>
        </div>
    </div>
</div>

<a class="vs-sr-only" href="#contenido">Saltar al contenido</a>

<header class="vs-header">
    <div class="vs-container">
        <div class="vs-brand" aria-label="Voz Segura">
            <img class="vs-brand__logo"
                 th:src="@{/img/logo-voz-segura.svg?v=4}"
                 src="/img/logo-voz-segura.svg?v=4"
                 alt="Logo de Voz Segura">
            <div class="vs-brand__text">
                <div class="vs-brand__title">Voz Segura</div>
                <div class="vs-brand__subtitle">Confirmaci√≥n de Identidad</div>
            </div>
        </div>
    </div>
</header>

<main id="contenido" class="vs-container">
    <section class="vs-card" aria-labelledby="titulo-confirm">

        <div class="vs-card__header">
            <h1 id="titulo-confirm" class="vs-card__title">Identidad Verificada</h1>
            <p class="vs-card__subtitle" th:if="${staffRole == 'ADMIN' or staffRole == 'ANALYST'}">Procede con la verificaci√≥n de seguridad para acceder</p>
            <p class="vs-card__subtitle" th:if="${staffRole != 'ADMIN' and staffRole != 'ANALYST'}">Completa el formulario para continuar</p>
        </div>

        <!-- Mensaje de error -->
        <div th:if="${error}" class="vs-alert vs-alert--error vs-mb-4" role="alert" th:text="${error}">
            Error
        </div>

        <!-- Usuario verificado - Dise√±o profesional sin emojis -->
        <div class="vs-success-box">
            <h3 class="vs-success-box__title">Usuario Verificado</h3>
            <p class="vs-success-box__text">Tu identidad ha sido verificada exitosamente mediante biometr√≠a.</p>
        </div>

        <!-- Formulario de confirmaci√≥n -->
        <form th:action="@{/auth/verify-complete}"
              method="post"
              class="vs-form"
              id="confirmForm"
              novalidate>

            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <input type="hidden" name="diditSessionId" th:value="${diditSessionId}"/>
            <!-- Checkbox oculto para validaci√≥n -->
            <input type="checkbox" id="termsAccepted" name="termsAccepted" required style="display: none;"/>

            <!-- CAPTCHA Turnstile -->
            <div class="vs-form__group">
                <label class="vs-form__label vs-form__label--required">Verificaci√≥n de Seguridad:</label>
                <div class="cf-turnstile"
                     th:attr="data-sitekey=${turnstileSiteKey}"
                     data-theme="light"
                     aria-label="Widget de Cloudflare Turnstile para verificaci√≥n de seguridad"></div>
            </div>

            <!-- Secci√≥n de T√©rminos y Condiciones -->
            <div class="vs-form__group vs-mt-4">
                <div id="termsStatus" class="vs-alert vs-alert--warning">
                    <span id="termsNotAccepted">
                        <strong>T√©rminos pendientes:</strong> Debes aceptar los t√©rminos y condiciones para continuar.
                        <button type="button" id="openTermsBtn" class="vs-button vs-button--sm vs-button--secondary vs-ml-2">
                            Ver t√©rminos
                        </button>
                    </span>
                    <span id="termsAcceptedMsg" style="display: none;">
                        <strong>T√©rminos aceptados.</strong>
                        <a href="#" id="viewTermsLink" class="vs-link">Ver t√©rminos nuevamente</a>
                    </span>
                </div>
            </div>

            <!-- Botones de acci√≥n -->
            <div class="vs-button-group vs-mt-6">
                <a th:href="@{/auth/login}" class="vs-button vs-button--ghost">Volver</a>

                <button type="submit"
                        id="submitBtn"
                        form="confirmForm"
                        class="vs-button vs-button--primary"
                        disabled>
                    <span th:text="${staffRedirectButton} ?: 'Continuar'">Continuar</span>
                </button>
            </div>
        </form>

        <!-- Nota de seguridad -->
        <div class="vs-alert vs-alert--info vs-mt-6" role="status" aria-live="polite">
            <strong>Nota de seguridad:</strong>
            <span th:if="${staffRole == 'ADMIN' or staffRole == 'ANALYST'}">
                Se requerir√° tu clave secreta y c√≥digo OTP por email para acceder al panel. Esto garantiza m√°xima seguridad.
            </span>
            <span th:if="${staffRole != 'ADMIN' and staffRole != 'ANALYST'}">
                Despu√©s de aceptar, podr√°s proceder a crear tu denuncia. Todos tus datos se procesar√°n con m√°xima seguridad y privacidad.
            </span>
        </div>

    </section>
</main>

<script>
(function() {
    'use strict';

    console.log('üîß Inicializando modal de t√©rminos y condiciones');

    // Obtener elementos del DOM
    const modal = document.getElementById('termsModal');
    const acceptBtn = document.getElementById('acceptTermsBtn');
    const termsCheck = document.getElementById('termsAccepted');
    const submitBtn = document.getElementById('submitBtn');
    const closeBtns = document.querySelectorAll('[data-terms-close]');
    const openTermsBtn = document.getElementById('openTermsBtn');
    const viewTermsLink = document.getElementById('viewTermsLink');
    const termsNotAccepted = document.getElementById('termsNotAccepted');
    const termsAcceptedMsg = document.getElementById('termsAcceptedMsg');
    const termsStatus = document.getElementById('termsStatus');

    // Validar que todos los elementos cr√≠ticos existen
    if (!modal) {
        console.error('‚ùå Error: Modal no encontrado');
        return;
    }
    if (!acceptBtn) {
        console.error('‚ùå Error: Bot√≥n de aceptar no encontrado');
        return;
    }
    if (!termsCheck) {
        console.error('‚ùå Error: Checkbox de t√©rminos no encontrado');
        return;
    }
    if (!submitBtn) {
        console.error('‚ùå Error: Bot√≥n de submit no encontrado');
        return;
    }

    console.log('‚úÖ Todos los elementos del DOM encontrados');

    function openModal() {
        console.log('üìÇ Abriendo modal de t√©rminos');
        modal.classList.remove('vs-modal--hidden');
        modal.style.display = 'flex';

        // Asegurar que el modal est√© visible
        modal.style.opacity = '1';
        modal.style.visibility = 'visible';

        // Forzar el foco en el bot√≥n de aceptar
        setTimeout(() => {
            if (acceptBtn) {
                acceptBtn.focus();
                console.log('‚úÖ Foco establecido en bot√≥n de aceptar');
            }
        }, 100);
    }

    function closeModal() {
        console.log('üìÅ Cerrando modal de t√©rminos');
        modal.classList.add('vs-modal--hidden');
        modal.style.display = '';
    }

    function updateUI() {
        const accepted = termsCheck.checked;
        console.log('üîÑ Actualizando UI. T√©rminos aceptados:', accepted);

        submitBtn.disabled = !accepted;

        if (accepted) {
            if (termsNotAccepted) termsNotAccepted.style.display = 'none';
            if (termsAcceptedMsg) termsAcceptedMsg.style.display = 'inline';
            if (termsStatus) {
                termsStatus.classList.remove('vs-alert--warning');
                termsStatus.classList.add('vs-alert--success');
            }
            console.log('‚úÖ UI actualizada: t√©rminos aceptados');
        } else {
            if (termsNotAccepted) termsNotAccepted.style.display = 'inline';
            if (termsAcceptedMsg) termsAcceptedMsg.style.display = 'none';
            if (termsStatus) {
                termsStatus.classList.remove('vs-alert--success');
                termsStatus.classList.add('vs-alert--warning');
            }
            console.log('‚ö†Ô∏è UI actualizada: t√©rminos pendientes');
        }
    }

    // Evento: Aceptar t√©rminos
    acceptBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('üëÜ Click en bot√≥n aceptar t√©rminos');
        termsCheck.checked = true;
        updateUI();
        closeModal();
    });

    // Evento: Abrir modal desde bot√≥n
    if (openTermsBtn) {
        openTermsBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('üëÜ Click en bot√≥n abrir t√©rminos');
            openModal();
        });
    }

    // Evento: Abrir modal desde enlace
    if (viewTermsLink) {
        viewTermsLink.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('üëÜ Click en enlace ver t√©rminos');
            openModal();
        });
    }

    // Evento: Cerrar modal con botones
    closeBtns.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('üëÜ Click en bot√≥n cerrar');
            // Solo cerrar si ya acept√≥
            if (termsCheck.checked) {
                closeModal();
            } else {
                console.log('‚ö†Ô∏è No se puede cerrar: t√©rminos no aceptados');
            }
        });
    });

    // Evento: Cerrar con ESC solo si ya acept√≥
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !modal.classList.contains('vs-modal--hidden')) {
            if (termsCheck.checked) {
                console.log('‚å®Ô∏è Cerrando modal con ESC');
                closeModal();
            } else {
                console.log('‚ö†Ô∏è ESC bloqueado: t√©rminos no aceptados');
            }
        }
    });

    // Evento: Cerrar al hacer clic fuera solo si ya acept√≥
    modal.addEventListener('click', function(e) {
        if (e.target === modal && termsCheck.checked) {
            console.log('üëÜ Click fuera del modal, cerrando');
            closeModal();
        } else if (e.target === modal && !termsCheck.checked) {
            console.log('‚ö†Ô∏è Click fuera bloqueado: t√©rminos no aceptados');
        }
    });

    // Prevenir propagaci√≥n de clicks dentro del modal
    const modalContent = modal.querySelector('.vs-modal');
    if (modalContent) {
        modalContent.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    }

    // Inicializar UI
    updateUI();

    // Mostrar modal autom√°ticamente al cargar
    setTimeout(function() {
        console.log('üöÄ Mostrando modal autom√°ticamente');
        openModal();
    }, 500);

    console.log('‚úÖ Modal inicializado correctamente');
})();
</script>

</body>
</html>
