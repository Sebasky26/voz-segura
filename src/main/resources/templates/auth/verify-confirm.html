<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Voz Segura — Confirmar Identidad</title>
    <link rel="stylesheet" th:href="@{/css/main.css?v=5}" href="/css/main.css?v=5"/>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
</head>

<body class="vs-app">

<!-- Modal Términos y Condiciones -->
<div class="vs-modal-overlay vs-modal--hidden" id="termsModal" role="dialog" aria-modal="true" aria-labelledby="termsTitle">
    <div class="vs-modal" role="document">
        <div class="vs-modal__header">
            <h2 id="termsTitle">Términos y Condiciones</h2>
            <button type="button" class="vs-modal__close" data-terms-close aria-label="Cerrar">&times;</button>
        </div>

        <div class="vs-modal__body">
            <div class="vs-terms">
                <p><strong>Fecha de vigencia: enero 2026</strong></p>

                <h3>Validación de identidad</h3>
                <ul>
                    <li>La identidad se valida para evitar suplantaciones.</li>
                    <li>Los datos se usan solo para este proceso de acceso.</li>
                </ul>

                <h3>Protección de identidad</h3>
                <ul>
                    <li>La identidad del denunciante no se muestra al personal que revisa los casos.</li>
                    <li>Las denuncias y evidencias se almacenan cifradas y se eliminan tras un período de retención definido.</li>
                </ul>

                <h3>Revelación excepcional</h3>
                <ul>
                    <li>La identidad solo podrá revelarse en casos excepcionales y bajo autorización formal de la autoridad competente.</li>
                </ul>

                <h3>Uso responsable</h3>
                <ul>
                    <li>No se permite enviar información falsa o malintencionada.</li>
                    <li>No se permite subir contenido ilegal.</li>
                    <li>Las evidencias deben ser lícitas y pertinentes al caso.</li>
                </ul>

                <h3>Registros y auditoría</h3>
                <ul>
                    <li>Los registros de auditoría no almacenan datos personales del denunciante.</li>
                    <li>Solo se guardan datos mínimos necesarios para trazabilidad del sistema.</li>
                </ul>
            </div>
        </div>

        <div class="vs-modal__footer">
            <button type="button" class="vs-button vs-button--secondary" data-terms-close>Cerrar</button>
            <button type="button" class="vs-button vs-button--primary" id="acceptTermsBtn">Aceptar términos</button>
        </div>
    </div>
</div>

<a class="vs-sr-only" href="#contenido">Saltar al contenido</a>

<header class="vs-header">
    <div class="vs-container">
        <div class="vs-brand" aria-label="Voz Segura">
            <img class="vs-brand__logo"
                 th:src="@{/img/logo-voz-segura.svg?v=4}"
                 src="/img/logo-voz-segura.svg?v=4"
                 alt="Logo de Voz Segura">
            <div class="vs-brand__text">
                <div class="vs-brand__title">Voz Segura</div>
                <div class="vs-brand__subtitle">Confirmación de Identidad</div>
            </div>
        </div>
    </div>
</header>

<main id="contenido" class="vs-container">
    <section class="vs-card" aria-labelledby="titulo-confirm">

        <div class="vs-card__header">
            <h1 id="titulo-confirm" class="vs-card__title">Identidad Verificada</h1>
            <p class="vs-card__subtitle" th:if="${staffRole == 'ADMIN' or staffRole == 'ANALYST'}">Procede con la verificación de seguridad para acceder</p>
            <p class="vs-card__subtitle" th:if="${staffRole != 'ADMIN' and staffRole != 'ANALYST'}">Completa el formulario para continuar</p>
        </div>

        <!-- Mensaje de error -->
        <div th:if="${error}" class="vs-alert vs-alert--error vs-mb-4" role="alert" th:text="${error}">
            Error
        </div>

        <!-- Usuario verificado - Diseño profesional sin emojis -->
        <div class="vs-success-box">
            <h3 class="vs-success-box__title">Usuario Verificado</h3>
            <p class="vs-success-box__text">Tu identidad ha sido verificada exitosamente mediante biometría.</p>
        </div>

        <!-- Formulario de confirmación -->
        <form th:action="@{/auth/verify-complete}"
              method="post"
              class="vs-form"
              id="confirmForm"
              novalidate>

            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <input type="hidden" name="diditSessionId" th:value="${diditSessionId}"/>
            <!-- Checkbox oculto para validación -->
            <input type="checkbox" id="termsAccepted" name="termsAccepted" required style="display: none;"/>

            <!-- CAPTCHA Turnstile -->
            <div class="vs-form__group">
                <label class="vs-form__label vs-form__label--required">Verificación de Seguridad:</label>
                <div class="cf-turnstile"
                     th:attr="data-sitekey=${turnstileSiteKey}"
                     data-theme="light"
                     aria-label="Widget de Cloudflare Turnstile para verificación de seguridad"></div>
            </div>

            <!-- Sección de Términos y Condiciones -->
            <div class="vs-form__group vs-mt-4">
                <div id="termsStatus" class="vs-alert vs-alert--warning">
                    <span id="termsNotAccepted">
                        <strong>Términos pendientes:</strong> Debes aceptar los términos y condiciones para continuar.
                        <button type="button" id="openTermsBtn" class="vs-button vs-button--sm vs-button--secondary vs-ml-2">
                            Ver términos
                        </button>
                    </span>
                    <span id="termsAcceptedMsg" style="display: none;">
                        <strong>Términos aceptados.</strong>
                        <a href="#" id="viewTermsLink" class="vs-link">Ver términos nuevamente</a>
                    </span>
                </div>
            </div>

            <!-- Botones de acción -->
            <div class="vs-button-group vs-mt-6">
                <a th:href="@{/auth/login}" class="vs-button vs-button--ghost">Volver</a>

                <button type="submit"
                        id="submitBtn"
                        form="confirmForm"
                        class="vs-button vs-button--primary"
                        disabled>
                    <span th:text="${staffRedirectButton} ?: 'Continuar'">Continuar</span>
                </button>
            </div>
        </form>

        <!-- Nota de seguridad -->
        <div class="vs-alert vs-alert--info vs-mt-6" role="status" aria-live="polite">
            <strong>Nota de seguridad:</strong>
            <span th:if="${staffRole == 'ADMIN' or staffRole == 'ANALYST'}">
                Se requerirá tu clave secreta y código OTP por email para acceder al panel. Esto garantiza máxima seguridad.
            </span>
            <span th:if="${staffRole != 'ADMIN' and staffRole != 'ANALYST'}">
                Después de aceptar, podrás proceder a crear tu denuncia. Todos tus datos se procesarán con máxima seguridad y privacidad.
            </span>
        </div>

    </section>
</main>

<script>
(function() {
    const modal = document.getElementById('termsModal');
    const acceptBtn = document.getElementById('acceptTermsBtn');
    const termsCheck = document.getElementById('termsAccepted');
    const submitBtn = document.getElementById('submitBtn');
    const closeBtns = document.querySelectorAll('[data-terms-close]');
    const openTermsBtn = document.getElementById('openTermsBtn');
    const viewTermsLink = document.getElementById('viewTermsLink');
    const termsNotAccepted = document.getElementById('termsNotAccepted');
    const termsAcceptedMsg = document.getElementById('termsAcceptedMsg');
    const termsStatus = document.getElementById('termsStatus');

    function openModal() {
        modal.classList.remove('vs-modal--hidden');
        acceptBtn.focus();
    }

    function closeModal() {
        modal.classList.add('vs-modal--hidden');
    }

    function updateUI() {
        const accepted = termsCheck.checked;
        submitBtn.disabled = !accepted;

        if (accepted) {
            termsNotAccepted.style.display = 'none';
            termsAcceptedMsg.style.display = 'inline';
            termsStatus.classList.remove('vs-alert--warning');
            termsStatus.classList.add('vs-alert--success');
        } else {
            termsNotAccepted.style.display = 'inline';
            termsAcceptedMsg.style.display = 'none';
            termsStatus.classList.remove('vs-alert--success');
            termsStatus.classList.add('vs-alert--warning');
        }
    }

    // Mostrar modal automáticamente al cargar
    setTimeout(openModal, 500);

    // Aceptar términos
    acceptBtn.addEventListener('click', function() {
        termsCheck.checked = true;
        updateUI();
        closeModal();
    });

    // Abrir modal desde botón o enlace
    if (openTermsBtn) openTermsBtn.addEventListener('click', openModal);
    if (viewTermsLink) viewTermsLink.addEventListener('click', function(e) {
        e.preventDefault();
        openModal();
    });

    // Cerrar modal (solo con botones, no con ESC ni clic fuera si no ha aceptado)
    closeBtns.forEach(btn => btn.addEventListener('click', closeModal));

    // Cerrar con ESC solo si ya aceptó
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && termsCheck.checked) closeModal();
    });

    // Cerrar al hacer clic fuera solo si ya aceptó
    modal.addEventListener('click', function(e) {
        if (e.target === modal && termsCheck.checked) closeModal();
    });

    // Inicializar UI
    updateUI();
})();
</script>

</body>
</html>
