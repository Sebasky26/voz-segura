spring:
  datasource:
    spring:
      main:
        allow-bean-definition-overriding: true
    # Configuración de Supabase desde .env
    # CRÍTICO: PgBouncer en modo transacción no soporta prepared statements
    url: ${SUPABASE_DB_URL}
    username: ${SUPABASE_DB_USERNAME}
    password: ${SUPABASE_DB_PASSWORD}
    driver-class-name: org.postgresql.Driver
    hikari:
      # Pool reducido para desarrollo con PgBouncer
      maximum-pool-size: 3
      minimum-idle: 1
      connection-timeout: 60000
      idle-timeout: 30000
      max-lifetime: 180000
      keepalive-time: 30000
      validation-timeout: 5000
      auto-commit: true
      # CRÍTICO: Propiedades del driver PostgreSQL para PgBouncer
      # Los valores deben ser strings para que HikariCP los pase correctamente
      data-source-properties:
        prepareThreshold: "0"
        preparedStatementCacheQueries: "0"
        preparedStatementCacheSizeMiB: "0"
        ApplicationName: "voz-segura-dev"
  jpa:
    hibernate:
      ddl-auto: none
    show-sql: false # SEGURIDAD: Desactivado - expone PII
    properties:
      hibernate:
        format_sql: false # SEGURIDAD: Desactivado
        # CRÍTICO: Desactivar completamente prepared statements en Hibernate
        jdbc:
          batch_size: 0
          use_scrollable_resultset: false
          use_get_generated_keys: false
        # Desactivar caché de queries
        query:
          plan_cache_max_size: 64
  flyway:
    enabled: true
    locations: classpath:db/migration
    validate-on-migrate: false
    baseline-on-migrate: true
    # Configuración para PgBouncer
    connect-retries: 3
    lock-retry-count: 50
  servlet:
    multipart:
      max-file-size: 25MB
      max-request-size: 30MB
      enabled: true
  thymeleaf:
    cache: false

# JWT Development (desde .env)
# CRÍTICO: jwt.secret es OBLIGATORIO - no tiene default
jwt:
  secret: ${JWT_SECRET}
  expiration: ${JWT_EXPIRATION:86400000}

# Supabase (desde .env)
supabase:
  project-url: ${SUPABASE_PROJECT_URL}
  anon-key: ${SUPABASE_ANON_KEY}
  service-role-key: ${SUPABASE_SERVICE_ROLE_KEY}

# Configuracion AWS (desde .env)
aws:
  region: ${AWS_REGION}
  ses:
    from-email: ${AWS_SES_FROM_EMAIL}
  access:
    key-id: ${AWS_ACCESS_KEY_ID}
  secret:
    access-key: ${AWS_SECRET_ACCESS_KEY}

# Encryption (desde .env)
vozsegura:
  encryption:
    key-b64: ${VOZSEGURA_DATA_KEY_B64}

# Cloudflare (desde .env)
cloudflare:
  turnstile:
    site-key: ${CLOUDFLARE_SITE_KEY}
    secret-key: ${CLOUDFLARE_SECRET_KEY}

# Didit Biometric Verification (desde .env)
didit:
  app-id: ${DIDIT_APP_ID}
  api-key: ${DIDIT_API_KEY}
  webhook-url: ${DIDIT_WEBHOOK_URL}
  webhook-secret-key: ${DIDIT_WEBHOOK_SECRET_KEY}
  workflow-id: ${DIDIT_WORKFLOW_ID}
  api-url: ${DIDIT_API_URL}

server:
  port: 8082
  servlet:
    session:
      # ✅ TIMEOUT DE SESIÓN: 30 minutos de inactividad
      # Si el usuario no hace clic por 30 min, la sesión expira
      # Después de una denuncia exitosa, la sesión se invalida inmediatamente
      timeout: 30m
      tracking-modes: COOKIE
  error:
    whitelabel:
      enabled: false
    include-message: never

# Development Logging - SEGURO
logging:
  level:
    root: INFO
    com.vozsegura.vozsegura: INFO # SEGURIDAD: INFO solamente
    com.vozsegura.vozsegura.service.DiditService: INFO
    org.springframework.security: WARN # SEGURIDAD: NO DEBUG - expone tokens
    org.springframework.web: INFO # SEGURIDAD: NO DEBUG - expone request bodies
    org.hibernate.SQL: OFF # SEGURIDAD: Desactivado - expone PII
    org.hibernate.type.descriptor.sql.BasicBinder: OFF
    org.springframework.web.client: WARN # NO DEBUG - expone headers HTTP
  file:
    name: logs/voz-segura-dev.log
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%level] %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%level] [%thread] %logger{36} - %msg%n"
