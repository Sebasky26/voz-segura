@startuml C4_Component
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

LAYOUT_WITH_LEGEND()
LAYOUT_TOP_DOWN()

title Diagrama de Componentes C4 - Voz Segura

' ============================================
' CONTENEDOR 1: API GATEWAY (Puerto 8080)
' ============================================
Container_Boundary(gateway, "API Gateway") {
    Component(route_security, "RouteSecurityConfig", "@Component", "Define rutas públicas vs protegidas")
    Component(jwt_filter, "JwtAuthenticationGatewayFilterFactory", "@Component", "Valida JWT (HS256) y genera HMAC-SHA256")
    Component(route_locator, "GatewayConfig", "@Configuration", "Enruta /admin, /staff → Core:8082")
}

' ============================================
' CONTENEDOR 2: CORE APPLICATION (Puerto 8082)
' ============================================
Container_Boundary(core, "Core Application") {
    ' === CAPA DE SEGURIDAD (Filtros) ===
    Component(zero_trust_filter, "ZeroTrustGatewayFilter", "@Component @Order(1)", "Valida HMAC-SHA256 del Gateway (timing-safe)")
    Component(api_gateway_filter, "ApiGatewayFilter", "@Component @Order(2)", "Autoriza por userType: ADMIN/ANALYST/DENUNCIANTE")
    Component(security_config, "SecurityConfig", "@Configuration", "Spring Security + CSRF + sesiones HTTP + UserDetailsService")

    ' === CONTROLLERS ===
    Component(auth_controller, "UnifiedAuthController", "@Controller /auth", "MFA 5 pasos: Didit→Clave→OTP→JWT")
    Component(webhook_controller, "WebhookController", "@RestController /webhooks", "Callback Didit webhook")
    Component(denuncia_controller, "DenunciaController", "@Controller /denuncia", "Denuncias anónimas + Turnstile")
    Component(staff_controller, "StaffCaseController", "@Controller /staff", "Gestión casos (listar/clasificar/derivar)")
    Component(admin_controller, "AdminController", "@Controller /admin", "Panel admin: reglas/analistas/logs")
    Component(seguimiento_controller, "SeguimientoController", "@Controller /seguimiento", "Tracking público de denuncias")

    ' === SERVICES (Capa de Negocio) ===
    Component(unified_auth_service, "UnifiedAuthService", "@Service", "Orquesta MFA 5 pasos completo")
    Component(complaint_service, "ComplaintService", "@Service", "CRUD denuncias cifradas + derivación")
    Component(derivation_service, "DerivationService", "@Service", "Matching reglas + derivación automática")
    Component(didit_service, "DiditService", "@Service", "API Didit v3 (biometría)")
    Component(otp_service, "AwsSesOtpClient", "@Component", "Envío OTP por AWS SES")
    Component(turnstile_service, "CloudflareTurnstileService", "@Service", "Validación CAPTCHA Turnstile")
    Component(audit_service, "AuditService", "@Service", "Logs sin PII (GDPR)")
    Component(config_service, "SystemConfigService", "@Service", "Config dinámica desde BD")

    ' === SERVICIOS DE SEGURIDAD ===
    Component(encryption_service, "AesGcmEncryptionService", "@Service", "AES-256-GCM (IV 12 bytes, tag 128 bits)")
    Component(crypto_service, "CryptoService", "@Service", "Hashing SHA-256 + salt")
    Component(file_validation, "FileValidationService", "@Service", "Valida magic bytes + whitelist MIME")
    Component(jwt_provider, "JwtTokenProvider", "@Service", "Genera JWT HS256 (24h TTL)")

    ' === REPOSITORIES (Spring Data JPA) ===
    Component(staff_user_repo, "StaffUserRepository", "@Repository", "JPA → staff.staff_user")
    Component(complaint_repo, "ComplaintRepository", "@Repository", "JPA → denuncias.denuncia")
    Component(evidence_repo, "EvidenceRepository", "@Repository", "JPA → evidencias.evidencia")
    Component(derivation_rule_repo, "DerivationRuleRepository", "@Repository", "JPA → reglas_derivacion.regla_derivacion")
    Component(destination_entity_repo, "DestinationEntityRepository", "@Repository", "JPA → reglas_derivacion.entidad_destino")
    Component(persona_repo, "PersonaRepository", "@Repository", "JPA → registro_civil.personas")
    Component(didit_verification_repo, "DiditVerificationRepository", "@Repository", "JPA → registro_civil.didit_verification")
    Component(audit_event_repo, "AuditEventRepository", "@Repository", "JPA → logs.evento_auditoria")
    Component(system_config_repo, "SystemConfigRepository", "@Repository", "JPA → reglas_derivacion.configuracion")
}

' === BASE DE DATOS ===
ContainerDb(postgresql, "PostgreSQL 17", "Base de Datos", "7 schemas: denuncias, evidencias, logs, reglas_derivacion, staff, registro_civil, public")

' === SISTEMAS EXTERNOS ===
System_Ext(didit_api, "DIDIT API v3", "Verificación biométrica de identidad")
System_Ext(aws_ses, "AWS SES", "Envío de OTPs por email")
System_Ext(cloudflare_turnstile, "Cloudflare Turnstile", "CAPTCHA invisible/visible")

' ============================================
' RELACIONES: GATEWAY → CORE
' ============================================
Rel(route_security, jwt_filter, "Define rutas protegidas")
Rel(jwt_filter, route_locator, "Si JWT válido, genera HMAC")
Rel(route_locator, zero_trust_filter, "Enruta con headers firmados", "HTTP + HMAC")

' ============================================
' RELACIONES: FILTROS CORE (Cadena de seguridad)
' ============================================
Rel(zero_trust_filter, api_gateway_filter, "Si HMAC válido")
Rel(api_gateway_filter, security_config, "Consulta autorización")

' ============================================
' RELACIONES: FILTROS → CONTROLLERS
' ============================================
Rel(api_gateway_filter, auth_controller, "Ruta: /auth/**")
Rel(api_gateway_filter, webhook_controller, "Ruta: /webhooks/**")
Rel(api_gateway_filter, denuncia_controller, "Ruta: /denuncia/**")
Rel(api_gateway_filter, staff_controller, "Ruta: /staff/** (ANALYST/ADMIN)")
Rel(api_gateway_filter, admin_controller, "Ruta: /admin/** (ADMIN)")
Rel(api_gateway_filter, seguimiento_controller, "Ruta: /seguimiento/**")

' ============================================
' RELACIONES: CONTROLLERS → SERVICES
' ============================================
Rel(auth_controller, unified_auth_service, "Ejecuta flujo MFA")
Rel(auth_controller, didit_service, "Inicia sesión Didit")
Rel(auth_controller, otp_service, "Envía OTP")

Rel(webhook_controller, didit_service, "Procesa webhook")

Rel(denuncia_controller, complaint_service, "Crea denuncia")
Rel(denuncia_controller, turnstile_service, "Valida CAPTCHA")
Rel(denuncia_controller, didit_service, "Verifica identidad")

Rel(staff_controller, complaint_service, "CRUD casos")
Rel(staff_controller, derivation_service, "Deriva denuncia")

Rel(admin_controller, derivation_service, "CRUD reglas")
Rel(admin_controller, config_service, "Config sistema")

Rel(seguimiento_controller, complaint_service, "Consulta estado")

' ============================================
' RELACIONES: SERVICES → SERVICES
' ============================================
Rel(auth_controller, jwt_provider, "generateToken() tras MFA exitoso")

' ============================================
' RELACIONES: REPOSITORIES → BASE DE DATOS
' ============================================
Rel(staff_user_repo, postgresql, "CRUD", "JPA → schema=staff")
Rel(complaint_repo, postgresql, "CRUD", "JPA → schema=denuncias")
Rel(evidence_repo, postgresql, "CRUD", "JPA → schema=evidencias")
Rel(derivation_rule_repo, postgresql, "CRUD", "JPA → schema=reglas_derivacion")
Rel(destination_entity_repo, postgresql, "CRUD", "JPA → schema=reglas_derivacion")
Rel(persona_repo, postgresql, "CRUD", "JPA → schema=registro_civil")
Rel(didit_verification_repo, postgresql, "CRUD", "JPA → schema=registro_civil")
Rel(audit_event_repo, postgresql, "CRUD", "JPA → schema=logs")
Rel(system_config_repo, postgresql, "CRUD", "JPA → schema=reglas_derivacion")

' ============================================
' RELACIONES: SERVICES → REPOSITORIES (Spring Data JPA)
' ============================================
Rel(unified_auth_service, staff_user_repo, "findByCedulaAndEnabledTrue()")
Rel(unified_auth_service, otp_service, "sendOtp() + verifyOtp()")
Rel(unified_auth_service, audit_service, "logEvent()")

Rel(complaint_service, complaint_repo, "save() + findByTrackingId()")
Rel(complaint_service, evidence_repo, "save() + findByComplaint()")
Rel(complaint_service, persona_repo, "findByCedulaHash()")
Rel(complaint_service, encryption_service, "encryptToBase64() + decryptFromBase64()")
Rel(complaint_service, file_validation, "isValidEvidence()")
Rel(complaint_service, audit_service, "logEvent()")

Rel(derivation_service, derivation_rule_repo, "findMatchingRules() + findAllByOrderByNameAsc()")
Rel(derivation_service, destination_entity_repo, "findById()")
Rel(derivation_service, complaint_repo, "findById() + save()")
Rel(derivation_service, audit_service, "logEvent()")

Rel(didit_service, didit_verification_repo, "save() + findByDiditSessionId()")
Rel(didit_service, persona_repo, "findByCedulaHash()")
Rel(didit_service, crypto_service, "hashWithSalt()")

Rel(audit_service, audit_event_repo, "save() + findAll()")

Rel(config_service, system_config_repo, "findByConfigGroupAndActiveTrueOrderBySortOrderAsc()")

Rel(security_config, staff_user_repo, "UserDetailsService bean")

' ============================================
' RELACIONES: CONTROLLERS → REPOSITORIES (acceso directo)
' ============================================
Rel(staff_controller, evidence_repo, "findByComplaintId() (acceso directo)")
Rel(admin_controller, staff_user_repo, "findAll() (gestión analistas)")

' ============================================
' RELACIONES: SERVICIOS → EXTERNOS
' ============================================
Rel(didit_service, didit_api, "API REST v3", "HTTPS")
Rel(otp_service, aws_ses, "AWS SDK v2", "HTTPS")
Rel(turnstile_service, cloudflare_turnstile, "API REST", "HTTPS")

' ============================================
' AJUSTES DE LAYOUT (Mejora estética)
' ============================================
' Acercar base de datos a los repositorios
Lay_Distance(complaint_repo, postgresql, 1)
Lay_Distance(staff_user_repo, postgresql, 1)

' Agrupar sistemas externos más cerca
Lay_Distance(didit_service, didit_api, 1)
Lay_Distance(otp_service, aws_ses, 1)
Lay_Distance(turnstile_service, cloudflare_turnstile, 1)

@enduml